name: Update Package Versions

on:
  workflow_dispatch:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'

jobs:
  update-versions:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    container:
      image: 'registry.fedoraproject.org/fedora-minimal:latest'

    steps:
      - name: Prepare environment
        run: |
          microdnf -y install --nodocs --setopt=install_weak_deps=0 \
            git-core rpm-build curl jq rpmdevtools findutils sed

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"

      # Check for Wayland updates
      - name: Check Wayland updates
        run: |
          if [ -f "wayland/update.sh" ]; then
            chmod +x wayland/update.sh
            cd wayland
            ./update.sh || true
            cd ..
          fi

      # NOTE: wlroots-0.20.0 is PINNED and does not auto-update
      # Scroll 1.12+ includes wlroots in its source tree, so external wlroots
      # package is only for system integration. When a new wlroots version
      # is needed, manually create a new COPR/wlroots-X.Y.Z/ directory

      # Check for Scroll updates
      - name: Check Scroll updates
        run: |
          if [ -f "scroll/update.sh" ]; then
            chmod +x scroll/update.sh
            cd scroll
            ./update.sh || true
            cd ..
          fi

      # NOTE: ScrollFX is deprecated as of this update and will not be maintained
      # NOTE: SceneFX is no longer needed (was only for scrollfx)

      # Push changes if any
      - name: Push changes
        run: |
          if ! git diff --quiet HEAD origin/main; then
            echo "Pushing updates..."
            git push origin main
          else
            echo "No updates to push"
          fi
