name: Build Scroll Packages

on:
  workflow_dispatch:
  push:
    paths:
      - 'COPR/wlroots-0.20.0/**'
      - 'scroll/**'
      - 'wayland/**'
      - '.copr/**'
      - '.github/workflows/build.yml'
    branches: [ main ]

jobs:
  build-packages:
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[build-all]') ||
      contains(github.event.head_commit.message, '[build-scroll]')
    runs-on: ubuntu-latest
    container:
      image: 'registry.fedoraproject.org/fedora-minimal:latest'

    steps:
      - name: Prepare build environment
        run: |
          microdnf -y install --nodocs --setopt=install_weak_deps=0 \
            copr-cli git tar gzip jq

      - name: Configure COPR
        env:
          COPR_CONF: ${{ secrets.COPR_CONFIG }}
        run: |
          mkdir -p ~/.config
          echo "$COPR_CONF" > ~/.config/copr

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

      # Build Wayland (optional - scroll includes wlroots in source)
      - name: Build Wayland (optional)
        run: |
          echo "Building wayland (optional dependency)..."
          wayland_build_id=$(copr-cli build-package scrollwm/packages --nowait --name wayland 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          echo "WAYLAND_BUILD_ID=$wayland_build_id" >> $GITHUB_ENV
          echo "Wayland build ID: $wayland_build_id"

      # NOTE: wlroots-0.20.0 is optional since scroll 1.12+ includes wlroots in source tree
      # We build it for system integration and other packages that may need it
      - name: Build wlroots-0.20.0 (optional)
        run: |
          echo "Building wlroots-0.20.0 (optional - scroll has embedded wlroots)..."
          if [ "$WAYLAND_BUILD_ID" != "0" ]; then
            wlroots_build_id=$(copr-cli build-package scrollwm/packages --nowait --name wlroots-0.20.0 --after-build-id "$WAYLAND_BUILD_ID" 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          else
            wlroots_build_id=$(copr-cli build-package scrollwm/packages --nowait --name wlroots-0.20.0 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          fi
          echo "WLROOTS_BUILD_ID=$wlroots_build_id" >> $GITHUB_ENV
          echo "wlroots-0.20.0 build ID: $wlroots_build_id"

      # Build Scroll (can be built independently since it has embedded wlroots)
      - name: Build Scroll
        run: |
          echo "Building scroll..."
          # Scroll 1.12+ includes wlroots in source, so it can build independently
          # But we optionally wait for wlroots if it's building
          if [ "$WLROOTS_BUILD_ID" != "0" ]; then
            scroll_build_id=$(copr-cli build-package scrollwm/packages --nowait --name scroll --after-build-id "$WLROOTS_BUILD_ID" 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          else
            scroll_build_id=$(copr-cli build-package scrollwm/packages --nowait --name scroll 2>/dev/null | grep -o 'builds: [0-9]*' | cut -d' ' -f2 || echo "0")
          fi
          echo "SCROLL_BUILD_ID=$scroll_build_id" >> $GITHUB_ENV
          echo "Scroll build ID: $scroll_build_id"

      # Check build status
      - name: Check build status
        if: always()
        run: |
          echo "Waiting for builds to register..."
          sleep 60

          echo "=== Build Status Summary ==="
          copr-cli list-builds scrollwm/packages --output-format text-row | head -30

          echo ""
          echo "=== Build IDs ==="
          echo "Wayland: $WAYLAND_BUILD_ID (optional)"
          echo "wlroots-0.20.0: $WLROOTS_BUILD_ID (optional - scroll has embedded wlroots)"
          echo "Scroll: $SCROLL_BUILD_ID"

          echo ""
          echo "Monitor builds at: https://copr.fedorainfracloud.org/coprs/scrollwm/packages/builds/"
          
          echo ""
          echo "=== Important Note ==="
          echo "Scroll 1.12+ includes its own wlroots fork (based on 0.20) in the source tree."
          echo "The wlroots-0.20.0 package is built for system integration but not required by scroll."
